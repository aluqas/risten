# Gateway Design Philosophy

本ドキュメントでは、`risten` の Gateway 設計における核心的な思想と方針を定義します。
(Based on legacy gateway notes)

## 1. コアコンセプト

### 巨大 Match 文の抽象化
Gateway の本質は「飛んでくる多種多様なイベント (EventKind) をどう振り分けるか」という巨大な `match` 文の構築にあります。
`risten` は、この `match` 文を開発者が手書きするのではなく、**宣言的かつ型安全に構築するための抽象化**を提供します。

### ゼロコスト・静的 Listener
- **方針**: メモリ効率とパフォーマンスを最大化するため、可能な限り静的に解決できる Listener を提供します。
- **体験**: `serenity` のような宣言的な登録（"ただ書けば動く"）を目指しつつ、内部では `HList` や静的ディスパッチによって最適化されます。
- **ネスト**: Listener は階層構造を持ち、ユニークなイベントや共通化されたイベント（例: Prefix Command, Mention）を抽象化します。

## 2. メモリ効率の最大化 (Data Control)

Python 製 Bot でありがちな「とりあえず全てオブジェクトにする」非効率を排除します。

### パイプラインでの枝刈り (Pruning)
- **原則**: パイプラインの中で、Feature が必要としていないデータは即座に Drop します。
- **コピー制御**:
  - `Clone` や `Arc` の使用を最小限に抑えます。
  - 必要なデータだけを `repo` 層や `feature` 層へ運びます。

### データの所在
- どのデータを落とし、どのデータを運ぶかを明示的にコントロールします。
- **ID 参照**: 巨大なオブジェクトそのものではなく、軽量な ID のみをパイプラインで回し、必要な場合のみ Repository からデータを引く（または遅延ロードする）アプローチを推奨します。

## 3. 抽象化の境界

### Feature と Gateway の役割分担
- **Gateway**:
  - イベントの正規化、共通処理（ログ、メトリクス）、ルーティング、データ制御を担当。
  - "重武装" しすぎず、アプリ的なユニーク化（フィルタリング）のみを行い、ビジネスロジックは Feature に委譲します。
- **Feature**:
  - 具体的なビジネスロジックを実装。
  - Gateway が提供する抽象化されたイベント（例: `CommandContext`）を受け取ります。

### 不可逆な隠蔽の回避
- DSL によって詳細を隠蔽しすぎると、低レイヤの制御ができなくなります。
- あくまで「抽象化」であり、必要であれば生の `Event` にアクセスできる手段（`Hook`）を残します。
